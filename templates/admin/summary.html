{% extends 'layout.html' %}

{% block title %}
    <title>Admin Dashboard Summary</title>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 mb-5">

    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col text-center">
            <h1 class="fw-bold text-light mb-1">Admin Dashboard</h1>
            <p class="lead text-secondary">System overview, usage stats, and quick actions</p>
        </div>
    </div>

    <!-- Stat Cards Row -->
    <div class="row g-3 justify-content-center mb-5">
        <div class="col-12 col-sm-6 col-md-4 col-xl-2 mx-2">
            <div class="card bg-secondary-subtle text-light shadow h-100 border-secondary">
                <div class="card-body text-center">
                    <i class="bi bi-people-fill fs-2 text-primary mb-2"></i>
                    <h5 class="card-title mb-2">Total Users</h5>
                    <h2 class="fw-bold">{{ total_users }}</h2>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-md-4 col-xl-2 mx-2">
            <div class="card bg-secondary-subtle text-light shadow h-100 border-secondary">
                <div class="card-body text-center">
                    <i class="bi bi-building fs-2 text-success mb-2"></i>
                    <h5 class="card-title mb-2">Parking Lots</h5>
                    <h2 class="fw-bold">{{ total_lots }}</h2>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-md-4 col-xl-2 mx-2">
            <div class="card bg-secondary-subtle text-light shadow h-100 border-secondary">
                <div class="card-body text-center">
                    <i class="bi bi-grid-3x3-gap-fill fs-2 text-warning mb-2"></i>
                    <h5 class="card-title mb-2">Total Spots</h5>
                    <h2 class="fw-bold">{{ total_spots }}</h2>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-md-4 col-xl-2 mx-2">
            <div class="card bg-secondary-subtle text-light shadow h-100 border-secondary">
                <div class="card-body text-center">
                    <i class="bi bi-calendar2-week fs-2 text-info mb-2"></i>
                    <h5 class="card-title mb-2">Total Reservations</h5>
                    <h2 class="fw-bold">{{ total_reservations }}</h2>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-md-4 col-xl-2 mx-2">
            <div class="card bg-secondary-subtle text-light shadow h-100 border-secondary">
                <div class="card-body text-center">
                    <i class="bi bi-currency-rupee fs-2 text-warning mb-2"></i>
                    <h5 class="card-title mb-2">Total Revenue</h5>
                    <h2 class="fw-bold">â‚¹{{ total_revenue or '0.00' }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts & Trends Section -->
    <div class="row g-4 mb-4">

        <!-- Left: Booked vs Vacant Pie Chart (1/3 width) -->
        <div class="col-12 col-lg-4 d-flex flex-column">
            <div class="card bg-dark text-light shadow border-secondary h-100">
                <div class="card-header bg-secondary-subtle text-light">
                    <i class="bi bi-pie-chart-fill me-2"></i>Spot Occupancy
                </div>
                <div class="card-body d-flex justify-content-center align-items-center p-5" >
                    <canvas id="spotPieChart" width="150" height="150"></canvas>
                </div>
                <div class="card-footer bg-dark text-center">
                    <span class="badge bg-success me-2">Vacant: {{ vacant_spots }}</span>
                    <span class="badge bg-danger">Booked: {{ booked_spots }}</span>
                </div>
            </div>
        </div>

        <!-- Right: Reservations + Revenue (2/3 width, stacked) -->
        <div class="col-12 col-lg-8">
            <div class="row h-100">
                <!-- Top: Reservations Over Time -->
                <div class="col-12 mb-2" style="height:275px;">
                    <div class="card bg-dark text-light shadow border-secondary h-100">
                        <div class="card-header bg-secondary-subtle text-light">
                            <i class="bi bi-graph-up-arrow me-2"></i> Reservations Over Time
                        </div>
                        <div class="card-body h-100">
                            <canvas id="reservationsChart" style="height:180px; max-height:200px"></canvas>
                        </div>
                    </div>
                </div>
                <!-- Bottom: Revenue Over Time -->
                <div class="col-12" style="height:275px;">
                    <div class="card bg-dark text-light shadow border-secondary h-100">
                        <div class="card-header bg-secondary-subtle text-light">
                            <i class="bi bi-bar-chart-line-fill me-2"></i> Revenue Over Time
                        </div>
                        <div class="card-body h-100">
                            <canvas id="revenueChart" style="height:180px; max-height:200px"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity Tables/Lists -->
    <div class="row g-4 mb-3">
        <!-- Recent Reservations -->
        <div class="col-12 col-xl-6">
            <div class="card bg-dark text-light shadow border-secondary">
                <div class="card-header bg-secondary-subtle text-light">
                    <i class="bi bi-clock-history me-2"></i> Recent Reservations
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-borderless m-0 align-middle bg-dark text-light text-center">
                        <thead class="table-secondary">
                            <tr>
                                <th>#</th>
                                <th>User</th>
                                <th>Lot</th>
                                <th>Status</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if recent_reservations %}
                                {% for r in recent_reservations %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ r.user.full_name }}</td>
                                    <td>{{ r.spot.lot.prime_location_name }}</td>
                                    <td>
                                        {% if r.leaving_timestamp %}
                                            <span class="badge bg-danger">Released</span>
                                        {% else %}
                                            <span class="badge bg-success">Active</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ r.parking_timestamp.strftime('%d-%b-%Y %I:%M %p') }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-secondary">No recent reservations.</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Recent Users -->
        <div class="col-12 col-xl-6">
            <div class="card bg-dark text-light shadow border-secondary">
                <div class="card-header bg-secondary-subtle text-light">
                    <i class="bi bi-people me-2"></i> Recently Registered Users
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-borderless m-0 align-middle bg-dark text-light text-center">
                        <thead class="table-secondary">
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Registered</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if recent_users %}
                                {% for u in recent_users %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ u.full_name }}</td>
                                    <td>{{ u.email }}</td>
                                    <td>{{ u.registered_at.strftime('%d-%b-%Y') }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="4" class="text-center text-secondary">No new users.</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Quick Actions -->
    <div class="row g-4">
        <div class="col-12 col-xl-4">
            <a href="{{ url_for('admin.add_parking_lot') }}" class="btn btn-primary w-100 fw-bold shadow text-dark">
                <i class="bi bi-plus-circle me-2"></i>Add Parking Lot
            </a>
        </div>
        <div class="col-12 col-xl-4">
            <a href="{{ url_for('admin.all_users') }}" class="btn btn-info w-100 fw-bold shadow">
                <i class="bi bi-people-fill me-2"></i>All Users
            </a>
        </div>
        <div class="col-12 col-xl-4">
            <a href="{{ url_for('admin.all_reservations') }}" class="btn btn-warning w-100 fw-bold shadow text-dark">
                <i class="bi bi-calendar2-week me-2"></i>All Reservations
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Spot Occupancy Pie Chart
    var pieCanvas = document.getElementById('spotPieChart');
    if (pieCanvas) {
        var ctxPie = pieCanvas.getContext('2d');
        new Chart(ctxPie, {
            type: 'pie',
            data: {
                labels: ['Booked Spots', 'Vacant Spots'],
                datasets: [{
                    data: [{{ booked_spots }}, {{ vacant_spots }}],
                    backgroundColor: ['#dc3545', '#198754'],
                    hoverOffset: 8
                }]
            },
            options: {
                plugins: {
                    legend: {
                        labels: { color: 'white', font: { size: 14 } },
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Reservations Over Time Line Chart
    var resCanvas = document.getElementById('reservationsChart');
    if (resCanvas) {
        var ctxRes = resCanvas.getContext('2d');
        new Chart(ctxRes, {
            type: 'line',
            data: {
                labels: {{ reservations_chart_labels|tojson }},
                datasets: [{
                    label: 'Reservations',
                    data: {{ reservations_chart_data|tojson }},
                    fill: false,
                    borderColor: '#0d6efd',
                    backgroundColor: '#0d6efd',
                    tension: 0.2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                },
                plugins: {
                    legend: { labels: { color: 'white' } }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Revenue Over Time Bar Chart
    var revCanvas = document.getElementById('revenueChart');
    if (revCanvas) {
        var ctxRev = revCanvas.getContext('2d');
        new Chart(ctxRev, {
            type: 'bar',
            data: {
                labels: {{ revenue_chart_labels|tojson }},
                datasets: [{
                    label: 'Revenue (â‚¹)',
                    data: {{ revenue_chart_data|tojson }},
                    backgroundColor: '#ffc107',
                    borderColor: '#ffc107',
                    borderWidth: 1,
                    hoverBackgroundColor: '#ffca2c'
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'â‚¹' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    legend: { labels: { color: 'white' } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'â‚¹' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
});
</script>

{% endblock %}